<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Java 코드 피드백</title>
    <!-- 코드 어두운 테마 -->
    <!--    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet"/>-->
    <!-- 코드 밝은 테마 -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" rel="stylesheet"/>

    <!-- HEAD에 추가 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        body {
            font-family: Arial, sans-serif;
        }

        #container {
            position: relative;
            width: 1100px; /* 넉넉한 가로 */
            height: 700px; /* 충분한 세로 */
            overflow: auto;
            border: 1px solid #ccc;
        }


        pre {
            margin: 0;
            height: 100%;
            overflow: auto;
        }

        code {
            font-size: 10px;
        }

        #drawingCanvas {
            position: absolute;
            top: 0;
            left: 0;
            z-index: 10;
            width: 100%;
            height: 100%;
            display: none;
            pointer-events: none;
        }

        #drawingCanvas.active {
            display: block;
            pointer-events: auto;
        }

        #controls {
            margin-top: 1rem;
        }

        button {
            margin-right: 0.5rem;
        }
    </style>
</head>

<body>

<h2>📝 Java 코드 피드백</h2>

<div id="container">
    <!-- 코드 영역 -->
    <pre><code class="language-java" id="codeBlock">// 로딩 중...</code></pre>

    <!-- 캔버스 -->
    <canvas id="drawingCanvas"></canvas>
</div>

<div id="controls">
    <button onclick="toggleDrawing()">✏️ 펜 활성화</button>
    <button onclick="clearCanvas()">🗑️ 초기화</button>
    <button onclick="saveDrawing()">💾 이미지 저장</button>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-java.min.js"></script>

<script>
    const targetUrl = "https://raw.githubusercontent.com/kdit-2024-08month/spring-v4/master/src/main/java/org/example/springv3/user/UserService.java";

    // 코드 불러오기
    async function loadCode() {
        try {
            const response = await fetch(targetUrl);
            if (!response.ok) throw new Error("코드를 불러오지 못했습니다.");
            const code = await response.text();
            const codeBlock = document.getElementById('codeBlock');
            codeBlock.textContent = code;
            Prism.highlightElement(codeBlock);
        } catch (err) {
            document.getElementById('codeBlock').textContent = err.message;
        }
    }

    loadCode();

    // 드로잉 캔버스 설정
    const canvas = document.getElementById('drawingCanvas');
    const ctx = canvas.getContext('2d');
    let drawing = false;

    function resizeCanvas() {
        const container = document.getElementById('container');
        const ratio = window.devicePixelRatio || 1;
        canvas.width = container.clientWidth * ratio;
        canvas.height = container.clientHeight * ratio;
        canvas.style.width = container.clientWidth + 'px';
        canvas.style.height = container.clientHeight + 'px';
        ctx.setTransform(1, 0, 0, 1, 0, 0); // reset
        ctx.scale(ratio, ratio);
    }

    resizeCanvas();
    window.addEventListener('resize', resizeCanvas);

    function toggleDrawing() {
        canvas.classList.toggle('active');
    }

    canvas.addEventListener('mousedown', (e) => {
        drawing = true;
        ctx.beginPath();
        ctx.moveTo(e.offsetX, e.offsetY);
        ctx.strokeStyle = 'red';
        ctx.lineWidth = 2;
    });

    canvas.addEventListener('mousemove', (e) => {
        if (!drawing) return;
        ctx.lineTo(e.offsetX, e.offsetY);
        ctx.stroke();
    });

    canvas.addEventListener('mouseup', () => {
        drawing = false;
    });

    // 변경된 saveDrawing 함수
    function saveDrawing() {
        const container = document.getElementById('container');

        // 캔버스를 일시적으로 z-index 높여서 보이게
        canvas.classList.add('active');

        // 잠깐 기다렸다가 캡쳐
        setTimeout(() => {
            html2canvas(container, {
                scale: 2,
                useCORS: true
            }).then(canvas => {
                const link = document.createElement('a');
                link.download = 'feedback.png';
                link.href = canvas.toDataURL('image/png');
                link.click();
            });
        }, 100); // DOM 업데이트 기다림
    }


    function clearCanvas() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
    }
</script>

</body>

</html>
