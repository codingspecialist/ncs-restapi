{{> layout/header}}
<input type="hidden" id="paperId" value="{{model.paperId}}">

<div class="container mt-5 mb-5">
    <div class="paper-form-card">
        <form id="questionForm" enctype="multipart/form-data">
            <div class="form-section">
                <label for="elementId" class="form-label">능력단위 요소 선택 <span class="text-danger">*</span></label>
                <select class="form-select" id="elementId" required>
                    <option value="0">능력단위 요소를 선택해주세요 (필수)</option>
                    {{#model.elements}}
                        <option value="{{elementId}}">{{subtitle}}</option>
                    {{/model.elements}}
                </select>
            </div>

            <div class="form-section">
                <label for="questionNo" class="form-label">문제 번호</label>
                <input type="text" class="form-control" id="questionNo" placeholder="예: 1" value="{{model.expectNo}}"
                       required>
            </div>

            <div class="form-section">
                <label for="questionTitle" class="form-label">문제 제목</label>
                <input type="text" class="form-control" id="questionTitle" placeholder="문제 제목 입력" required>
            </div>

            <div class="form-section">
                <label for="stimulusImage" class="form-label">지문 이미지 (선택)</label>
                <input type="file" class="form-control" id="stimulusImage" accept="image/*">
            </div>

            <div class="form-section">
                <label class="form-label">문제 항목 (보기) <span class="text-danger">*</span></label>
                <div id="questionBox"></div>
                <button type="button" class="btn btn-outline-secondary mt-3" onclick="addOption()">+ 옵션 추가</button>
            </div>

            <button type="button" onclick="saveQuestion()" class="btn btn-primary mt-4">문제 등록</button>
        </form>
    </div>
</div>

<script>
    let optionCounter = 1;

    function addOption(no = optionCounter) {
        const box = document.querySelector("#questionBox");
        const div = document.createElement("div");
        div.className = "js-question-item";
        div.innerHTML = `
            <input type="hidden" class="js-option-no" value="${no}">
            <div class="mb-2">
                <label class="form-label">옵션 내용</label>
                <input type="text" class="form-control js-option-content" placeholder="옵션 내용 입력">
            </div>
            <div class="form-check">
                <input type="checkbox" class="form-check-input js-option-correct" id="correct-${no}">
                <label class="form-check-label" for="correct-${no}">정답으로 설정</label>
            </div>
            <div class="js-rubric-box">
                <label class="form-label">정답 루브릭 설명</label>
                <input type="text" class="form-control js-option-rubric" placeholder="정답 기준 설명">
                <label class="form-label mt-2">배점</label>
                <input type="number" class="form-control js-option-point" placeholder="예: 10" min="1">
            </div>
        `;
        box.appendChild(div);
        optionCounter++;
    }

    window.onload = () => {
        addOption();
    };

    document.addEventListener("change", (e) => {
        if (e.target.classList.contains("js-option-correct")) {
            const clickedCheckbox = e.target;
            const checkboxes = document.querySelectorAll(".js-option-correct");

            // 1. 모든 체크박스의 루브릭 박스를 숨기고 값을 초기화합니다.
            //    그리고 클릭된 체크박스를 제외한 나머지는 체크를 해제합니다.
            checkboxes.forEach(cb => {
                const item = cb.closest(".js-question-item");
                const rubricBox = item.querySelector(".js-rubric-box");
                const rubricInput = item.querySelector(".js-option-rubric");
                const pointInput = item.querySelector(".js-option-point");

                // 모든 루브릭 박스를 숨기고 값 초기화
                rubricBox.style.display = "none";
                rubricInput.value = "";
                pointInput.value = "";

                // 현재 클릭된 체크박스가 아니라면 체크를 해제합니다.
                if (cb !== clickedCheckbox) {
                    cb.checked = false;
                }
            });

            // 2. 이제 클릭된 체크박스가 'checked' 상태라면 해당 루브릭 박스만 보이게 합니다.
            if (clickedCheckbox.checked) {
                const item = clickedCheckbox.closest(".js-question-item");
                const rubricBox = item.querySelector(".js-rubric-box");
                rubricBox.style.display = "block";
            }
            // 만약 클릭된 체크박스가 checked가 아니라면 (사용자가 직접 해제한 경우),
            // 이미 1단계에서 숨겨지고 초기화되었으므로 추가 작업은 필요 없습니다.
        }
    });

    async function saveQuestion() {
        const formData = {
            elementId: document.getElementById("elementId").value,
            paperId: document.getElementById("paperId").value,
            questionNo: document.getElementById("questionNo").value,
            questionTitle: document.getElementById("questionTitle").value,
            stimulusFileBase64: "",
            options: []
        };

        const fileInput = document.getElementById("stimulusImage");
        await new Promise((resolve) => {
            convertFileToBase64(fileInput, (base64) => {
                formData.stimulusFileBase64 = base64;
                resolve();
            });
        });

        const optionItems = document.querySelectorAll("#questionBox .js-question-item");

        for (const item of optionItems) {
            const optionNo = item.querySelector(".js-option-no").value;
            const optionContent = item.querySelector(".js-option-content").value;
            const isCorrect = item.querySelector(".js-option-correct").checked;
            const rubricItem = item.querySelector(".js-option-rubric").value;
            const pointValue = item.querySelector(".js-option-point").value;

            formData.options.push({
                optionNo: optionNo,
                optionContent: optionContent,
                optionPoint: isCorrect ? Number(pointValue) : 0,
                rubricItem: isCorrect ? rubricItem : ""
            });
        }

        // 서버 전송 로직 추가
        fetch(`/api/paper-menu/paper/${formData.paperId}/question/save`, {
            method: "POST",
            headers: {
                "Content-Type": "application/json; charset=utf-8"
            },
            body: JSON.stringify(formData)
        })
            .then(response => {
                if (response.ok) {
                    location.href = `/api/paper-menu/paper/${formData.paperId}`;
                } else {
                    return response.json();
                }
            })
            .then(data => {
                if (data) {
                    alert(data.msg);
                }
            })
            .catch(error => {
                console.error("Error:", error);
                alert("문제 등록 중 오류가 발생했습니다.");
            });
    }

    function convertFileToBase64(fileInput, callback) {
        const file = fileInput.files[0];
        if (!file) {
            callback("");
            return;
        }

        const reader = new FileReader();
        reader.onload = function (e) {
            const base64 = e.target.result.split(',')[1];
            callback(base64);
        };
        reader.readAsDataURL(file);
    }
</script>

{{> layout/footer}}