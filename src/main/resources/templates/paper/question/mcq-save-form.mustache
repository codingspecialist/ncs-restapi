{{> layout/header}}
<input type="hidden" id="paperId" value="{{model.paperId}}">

<style>
    .paper-form-card {
        background: #ffffff;
        border-radius: 16px;
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.06);
        padding: 2.5rem;
        max-width: 840px;
        margin: 0 auto;
    }

    .form-label {
        font-weight: 600;
        margin-bottom: 0.3rem;
    }

    .form-control,
    .form-select {
        border-radius: 10px;
    }

    .btn-primary {
        padding: 0.75rem;
        font-weight: bold;
        font-size: 1rem;
        border-radius: 12px;
        width: 100%;
    }

    .form-section {
        margin-bottom: 1.5rem;
    }

    .questionItem {
        border: 1px solid #ddd;
        border-radius: 10px;
        padding: 1rem;
        background-color: #f9f9f9;
        margin-top: 1rem;
    }

    /* 첫 번째 questionItem 위에는 마진 없음 */
    .questionItem:first-child {
        margin-top: 0;
    }

    .rubric-box {
        margin-top: 0.75rem;
    }
</style>

<div class="container mt-5 mb-5">
    <div class="paper-form-card">
        <form id="questionForm" enctype="multipart/form-data">
            <div class="form-section">
                <label for="elementId" class="form-label">능력단위 요소 선택 <span class="text-danger">*</span></label>
                <select class="form-select" id="elementId" required>
                    <option value="0">능력단위 요소를 선택해주세요 (필수)</option>
                    {{#model.elements}}
                        <option value="{{elementId}}">{{subtitle}}</option>
                    {{/model.elements}}
                </select>
            </div>

            <div class="form-section">
                <label for="questionNo" class="form-label">문제 번호</label>
                <input type="text" class="form-control" id="questionNo" placeholder="예: 1" value="{{model.expectNo}}"
                       required>
            </div>

            <div class="form-section">
                <label for="questionTitle" class="form-label">문제 제목</label>
                <input type="text" class="form-control" id="questionTitle" placeholder="문제 제목 입력" required>
            </div>

            <div class="form-section">
                <label for="stimulusImage" class="form-label">지문 이미지 (선택)</label>
                <input type="file" class="form-control" id="stimulusImage" accept="image/*">
            </div>

            <div class="form-section">
                <label class="form-label">문제 항목 (보기) <span class="text-danger">*</span></label>
                <div id="questionBox"></div>
                <button type="button" class="btn btn-outline-secondary mt-3" onclick="addOption()">+ 옵션 추가</button>
            </div>

            <button type="button" onclick="saveQuestion()" class="btn btn-primary mt-4">문제 등록</button>
        </form>
    </div>
</div>

<script>
    let optionCounter = 1;

    function addOption(no = optionCounter) {
        const box = document.querySelector("#questionBox");
        const div = document.createElement("div");
        div.className = "questionItem";
        div.innerHTML = `
            <input type="hidden" class="optionNo" value="${no}"> <div class="mb-2">
                <label class="form-label">옵션 내용</label>
                <input type="text" class="form-control optionContent" placeholder="옵션 내용 입력">
            </div>
            <div class="form-check">
                <input type="checkbox" class="form-check-input optionCorrect" id="correct-${no}">
                <label class="form-check-label" for="correct-${no}">정답으로 설정</label>
            </div>
            <div class="rubric-box" style="display: none;">
                <label class="form-label">정답 루브릭 설명</label>
                <input type="text" class="form-control optionRubric" placeholder="정답 기준 설명">
                <label class="form-label mt-2">배점</label>
                <input type="number" class="form-control optionPoint" placeholder="예: 10" min="1">
            </div>
        `;
        box.appendChild(div);
        optionCounter++;
    }

    window.onload = () => {
        addOption();
    };

    document.addEventListener("change", (e) => {
        if (e.target.classList.contains("optionCorrect")) {
            const checkboxes = document.querySelectorAll(".optionCorrect");
            checkboxes.forEach(cb => {
                const item = cb.closest(".questionItem");
                const rubricBox = item.querySelector(".rubric-box");
                const rubricInput = item.querySelector(".optionRubric");
                const pointInput = item.querySelector(".optionPoint");


                // 현재 체크박스 외의 다른 체크박스는 모두 해제 (단일 정답 선택)
                if (cb !== e.target) {
                    cb.checked = false;
                    // 다른 체크박스가 해제될 때 관련 필드도 초기화
                    item.querySelector(".rubric-box").style.display = "none";
                    item.querySelector(".optionRubric").value = "";
                    item.querySelector(".optionPoint").value = "";
                }

                // 현재 체크박스의 상태에 따라 루브릭/배점 필드 표시/숨김
                if (e.target.checked) {
                    rubricBox.style.display = "block";
                } else {
                    rubricBox.style.display = "none";
                    rubricInput.value = "";
                    pointInput.value = "";
                }
            });
        }
    });

    async function saveQuestion() {
        const formData = {
            elementId: document.getElementById("elementId").value,
            paperId: document.getElementById("paperId").value,
            questionNo: document.getElementById("questionNo").value,
            questionTitle: document.getElementById("questionTitle").value,
            stimulusFileBase64: "",
            options: []
        };

        const fileInput = document.getElementById("stimulusImage");
        await new Promise((resolve) => {
            convertFileToBase64(fileInput, (base64) => {
                formData.stimulusFileBase64 = base64;
                resolve();
            });
        });

        const optionItems = document.querySelectorAll("#questionBox .questionItem"); // 선택자 통일

        for (const item of optionItems) { // forEach 대신 for...of 루프 사용 (async/await과 더 잘 맞음)
            const optionNo = item.querySelector(".optionNo").value; // optionNo 추가
            const optionContent = item.querySelector(".optionContent").value;
            const isCorrect = item.querySelector(".optionCorrect").checked;
            const rubricItem = item.querySelector(".optionRubric").value;
            const pointValue = item.querySelector(".optionPoint").value;

            formData.options.push({
                optionNo: optionNo, // 필드 이름 통일
                optionContent: optionContent, // 필드 이름 통일
                optionPoint: isCorrect ? Number(pointValue) : 0, // 조건부 배점 설정
                rubricItem: isCorrect ? rubricItem : "" // 조건부 루브릭 설정
            });
        }

        // 서버 전송 로직 추가
        fetch(`/api/paper-menu/paper/${formData.paperId}/question/save`, {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify(formData)
        }).then(async res => {
            if (!res.ok) throw new Error((await res.json()).msg);
            location.href = `/api/paper-menu/paper/${formData.paperId}`; // 성공 시 페이지 이동
        }).catch(err => {
            alert(err.message); // 에러 발생 시 알림
        });
    }

    function convertFileToBase64(fileInput, callback) {
        const file = fileInput.files[0];
        if (!file) {
            callback("");
            return;
        }
        const reader = new FileReader();
        reader.onload = () => callback(reader.result);
        reader.readAsDataURL(file);
    }
</script>

{{> layout/footer}}