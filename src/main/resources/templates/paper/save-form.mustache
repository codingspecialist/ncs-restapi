{{> layout/header}}

<div class="container mt-5 mb-5">
    <div class="paper-form-card">
        <div class="card-header">시험지를 등록 해주세요</div>

        <form id="save-form">
            <div class="form-section">
                <label for="paperType" class="form-label">평가 유형</label>
                <select class="form-control" name="paperType" id="paperType" required>
                    <option value="ORIGINAL">본평가</option>
                    <option value="RETEST">재평가</option>
                </select>
            </div>

            <div class="form-section">
                <label for="evaluationDate" class="form-label">평가일</label>
                <input type="date" class="form-control" name="evaluationDate" id="evaluationDate"
                       value="2024-05-10" required>
            </div>

            <div class="form-section">
                <label for="evaluationRoom" class="form-label">평가 장소</label>
                <input type="text" class="form-control" name="evaluationRoom" id="evaluationRoom"
                       placeholder="예: 본관 3층 302호" required>
            </div>

            <div class="form-section">
                <label for="evaluationDevice" class="form-label">평가 장비</label>
                <input type="text" class="form-control" name="evaluationDevice" id="evaluationDevice"
                       placeholder="예: 인터넷 가능 PC, IntelliJ 설치" required>
            </div>

            <div class="form-section">
                <label for="evaluationWay" class="form-label">평가 방법</label>
                <select class="form-select" name="evaluationWay" id="evaluationWay">
                    <option value="MCQ">객관식</option>
                    <option value="PRACTICAL">작업형</option>
                    <option value="PROJECT">프로젝트형(PBL)</option>
                </select>
            </div>

            <div id="guideGroup" style="display: none;">
                <div class="form-section">
                    <label for="pblTitle" class="form-label">주제 (필수)</label>
                    <input type="text" class="form-control" name="pblTitle" id="pblTitle"
                           placeholder="스프링 부트 기반으로 나만의 블로그 시스템을 설계하고 개발하세요.">
                </div>

                <div class="form-section">
                    <label for="pblScenario" class="form-label">시나리오 (필수)</label>
                    <textarea class="form-control" name="pblScenario" id="pblScenario" rows="5"
                              placeholder="당신은 스타트업의 백엔드 개발자로 채용되었습니다. 기획자는 블로그 서비스 기능을 요구했고, 디자이너는 아직 없기 때문에 API 문서 기반으로 프론트엔드와 협업해야 합니다. 당신은 다음 요구사항을 구현하고, 문서화 및 팀과 공유해야 합니다."></textarea>
                </div>

                <div class="form-section">
                    <label for="pblScenarioGuideLink" class="form-label">시나리오 상세 예시 링크 (필수)</label>
                    <input type="url" class="form-control" name="pblScenarioGuideLink" id="pblScenarioGuideLink"
                           placeholder="https://notion.so/scenario-guide">
                </div>

                <div class="form-section">
                    <label for="pblChallenge" class="form-label">도전과제 (선택)</label>
                    <textarea class="form-control" name="pblChallenge" id="pblChallenge" rows="3" placeholder="- 도커로 환경구성
- 통합테스트"></textarea>
                    <small class="form-text text-muted">※ 줄바꿈(Enter)으로 항목을 구분하세요.</small>
                </div>

                <div class="form-section">
                    <label for="pblSubmitFormat" class="form-label">제출항목 (필수)</label>
                    <textarea class="form-control" name="pblSubmitFormat" id="pblSubmitFormat" rows="4" placeholder="- 노션주소
- github 소스코드 포함
- 시연영상 포함
- API 명세 포함
- 협업 내역 (커밋, PR요청, 회의록, 일정관리)"></textarea>
                    <small class="form-text text-muted">※ 노션에 포함시켜 제출 받을 내용들을 함께 적어주세요</small>
                </div>

                <div class="form-section">
                    <label for="pblSubmitTemplateLink" class="form-label">제출 항목 샘플 등록 (선택)</label>
                    <input type="url" class="form-control" name="pblSubmitTemplateLink" id="pblSubmitTemplateLink"
                           placeholder="https://notion.so/template-link">
                </div>
            </div>

            <button type="submit" class="btn btn-primary mt-3 form-control">시험지 등록</button>
        </form>
    </div>
</div>

<script>
    const evaluationSelect = document.getElementById("evaluationWay");
    const guideGroup = document.getElementById("guideGroup");

    function toggleGuideFields() {
        const isMCQ = evaluationSelect.value === "MCQ";
        guideGroup.style.display = isMCQ ? "none" : "block";

        const paperTypeSelect = document.getElementById("paperType");

        if (!isMCQ) {
            // 비MCQ일 경우 본평가로 고정하고 수정 불가
            paperTypeSelect.value = "ORIGINAL";
            paperTypeSelect.setAttribute("disabled", "disabled");
        } else {
            // 객관식이면 선택 가능하게 복원
            paperTypeSelect.removeAttribute("disabled");
        }
    }

    evaluationSelect.addEventListener("change", toggleGuideFields);
    window.addEventListener('DOMContentLoaded', toggleGuideFields);

    document.getElementById('save-form').addEventListener('submit', async function (event) {
        event.preventDefault();

        const formData = {
            paperType: document.getElementById('paperType').value,
            evaluationDate: document.getElementById('evaluationDate').value,
            evaluationRoom: document.getElementById('evaluationRoom').value.trim(),
            evaluationDevice: document.getElementById('evaluationDevice').value.trim(),
            evaluationWay: document.getElementById('evaluationWay').value,
            pblTitle: document.getElementById('pblTitle')?.value.trim(),
            pblScenario: document.getElementById('pblScenario')?.value.trim(),
            pblScenarioGuideLink: document.getElementById('pblScenarioGuideLink')?.value.trim(),
            pblChallenge: document.getElementById('pblChallenge')?.value.trim(),
            pblSubmitFormat: document.getElementById('pblSubmitFormat')?.value.trim(),
            pblSubmitTemplateLink: document.getElementById('pblSubmitTemplateLink')?.value.trim(),
        };

        if (formData.evaluationWay !== 'MCQ') {
            if (!formData.pblTitle || !formData.pblScenario || !formData.pblSubmitFormat) {
                alert('PBL 유형은 과제 제목, 시나리오, 요구기능, 제출항목이 모두 필요합니다.');
                return;
            }
        }

        const url = `/api/paper-menu/subject/{{subjectId}}/paper/save`;

        try {
            const response = await fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(formData)
            });

            const responseData = await response.json();

            if (response.ok) {
                let subjectId = responseData.body;
                location.href = `/api/paper-menu/subject/${subjectId}/paper`;
            } else {
                alert((responseData.msg || '알 수 없는 오류가 발생했습니다.'));
            }
        } catch (error) {
            console.error('Fetch 에러:', error);
            alert('네트워크 오류 또는 서버 응답 처리 중 문제가 발생했습니다.');
        }
    });
</script>

{{> layout/footer}}